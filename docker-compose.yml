x-logging: &default-logging
  driver: json-file
  options:
    max-size: '10m'
    max-file: '5'
    compress: 'true'

services:
  migrator:
    build:
      context: .
      dockerfile: Dockerfile
      target: migrator
    env_file:
      - packages/db/.env.compose
    logging: *default-logging
    networks:
      - comp-net
  seeder:
    build:
      context: .
      dockerfile: Dockerfile
      target: migrator
    env_file:
      - packages/db/.env.compose
    command: sh -lc "bunx prisma generate --schema=node_modules/@trycompai/db/dist/schema.prisma && bun packages/db/prisma/seed/seed.js"
    logging: *default-logging
    networks:
      - comp-net
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: app
      args:
        NEXT_PUBLIC_BETTER_AUTH_URL: ${BETTER_AUTH_URL}
        NEXT_PUBLIC_PORTAL_URL: ${NEXT_PUBLIC_PORTAL_URL}
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
    ports:
      - '3000:3000'
    env_file:
      - apps/app/.env.compose
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:3000/api/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
    command: sh -lc "node apps/app/server.js"
    logging: *default-logging
    networks:
      - comp-net
  portal:
    build:
      context: .
      dockerfile: Dockerfile
      target: portal
      args:
        NEXT_PUBLIC_BETTER_AUTH_URL: ${BETTER_AUTH_URL_PORTAL}
    ports:
      - '3001:3000'
    env_file:
      - apps/portal/.env.compose
    restart: unless-stopped
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:3000/ || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
    logging: *default-logging
    networks:
      - comp-net
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile.multistage
      target: production
    ports:
      - "3333:3333"
    environment:
      - NODE_ENV=production
      - PORT=3333
    env_file:
      - apps/api/.env.compose

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3333/v1/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    networks:
      - comp-net

  pg-comp:
    image: postgres:17-alpine
    restart: always
    environment:
      - POSTGRES_DB=comp
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - '5432:5432'
    networks:
      - comp-net
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d comp']
      interval: 5s
      timeout: 2s
      retries: 20
    volumes:
      - pg-comp-data:/var/lib/postgresql/data
    command: postgres -c listen_addresses='*'
    logging:
      options:
        max-size: '10m'
        max-file: '3'

  minio:
    image: "bitnamilegacy/minio:latest"
    restart: unless-stopped
    environment:
      MINIO_ROOT_USER: "${MINIO_ROOT_USER:-admin}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD}"
      # Trigger.dev braucht mindestens "packets"
      MINIO_DEFAULT_BUCKETS: "packets,app,portal,task,questionnaire-uploads,knowledge-base,org-assets,api"
      MINIO_BROWSER: "on"
    volumes:
      - minio-data:/bitnami/minio/data
    networks:
      - comp-net
    ports:
      - "9000:9000"
      - "9001:9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 10s

  webapp:
    image: "ghcr.io/triggerdotdev/trigger.dev:${TRIGGER_IMAGE_TAG:-main}"
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      electric:
        condition: service_healthy
      minio:
        condition: service_healthy
      registry:
        condition: service_healthy
    user: root
    command: 'sh -c "chown -R node:node /home/node/shared && exec ./scripts/entrypoint.sh"'
    environment:
      # Ports / origins
      REMIX_APP_PORT: "3000"
      APP_ORIGIN: "${APP_ORIGIN}"
      LOGIN_ORIGIN: "${APP_ORIGIN}"
      API_ORIGIN: "${APP_ORIGIN}"
      DEV_OTEL_EXPORTER_OTLP_ENDPOINT: "${APP_ORIGIN}/otel"

      # Required secrets
      SESSION_SECRET: "${SESSION_SECRET}"
      MAGIC_LINK_SECRET: "${MAGIC_LINK_SECRET}"
      ENCRYPTION_KEY: "${ENCRYPTION_KEY}"
      MANAGED_WORKER_SECRET: "${MANAGED_WORKER_SECRET}"

      # Postgres
      DATABASE_URL: "postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-trigger}?schema=public&sslmode=disable"
      DIRECT_URL: "postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-trigger}?schema=public&sslmode=disable"

      # Redis
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      REDIS_TLS_DISABLED: "true"

      # Electric
      ELECTRIC_ORIGIN: "http://electric:3000"

      # Deploy registry (fÃ¼r local deploy/build)
      DEPLOY_REGISTRY_HOST: "${DEPLOY_REGISTRY_HOST:-localhost:5000}"
      DEPLOY_REGISTRY_NAMESPACE: "${DEPLOY_REGISTRY_NAMESPACE:-trigger}"
      # Username/Password optional; lokal meist leer lassen
      DEPLOY_REGISTRY_USERNAME: "${DEPLOY_REGISTRY_USERNAME:-}"
      DEPLOY_REGISTRY_PASSWORD: "${DEPLOY_REGISTRY_PASSWORD:-}"

      # Object storage (S3 via MinIO)
      OBJECT_STORE_BASE_URL: "http://minio:9000"
      OBJECT_STORE_ACCESS_KEY_ID: "${MINIO_ROOT_USER:-admin}"
      OBJECT_STORE_SECRET_ACCESS_KEY: "${MINIO_ROOT_PASSWORD}"

      # Bootstrap worker token in shared volume
      TRIGGER_BOOTSTRAP_ENABLED: "1"
      TRIGGER_BOOTSTRAP_WORKER_GROUP_NAME: "bootstrap"
      TRIGGER_BOOTSTRAP_WORKER_TOKEN_PATH: "/home/node/shared/worker_token"
      # Der Webapp-Prozess kann das Token in den shared path schreiben
      TRIGGER_WORKER_TOKEN: "file:///home/node/shared/worker_token"

      # ClickHouse (Run replication / logs)
      CLICKHOUSE_URL: "http://${CLICKHOUSE_USER:-default}:${CLICKHOUSE_PASSWORD}@clickhouse:8123?secure=false"
      CLICKHOUSE_LOG_LEVEL: "info"

      # Optional
      TRIGGER_TELEMETRY_DISABLED: "${TRIGGER_TELEMETRY_DISABLED:-0}"

    volumes:
      - shared-data:/home/node/shared
    ports:
      - "8030:3000"
    networks:
      - comp-net
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:3000/healthcheck',(r)=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  supervisor:
    image: "ghcr.io/triggerdotdev/supervisor:${TRIGGER_SUPERVISOR_TAG:-main}"
    restart: unless-stopped
    depends_on:
      docker-proxy:
        condition: service_healthy
      webapp:
        condition: service_healthy
    user: root
    command: 'sh -c "chown -R node:node /home/node/shared && exec /usr/bin/dumb-init -- pnpm run --filter supervisor start"'
    environment:
      TRIGGER_API_URL: "http://webapp:3000"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://webapp:3000/otel"

      # Must match webapp
      MANAGED_WORKER_SECRET: "${MANAGED_WORKER_SECRET}"

      # Worker token comes from shared volume (bootstrap writes it)
      TRIGGER_WORKER_TOKEN: "file:///home/node/shared/worker_token"

      # Workload API (internal)
      TRIGGER_WORKLOAD_API_DOMAIN: "supervisor"
      TRIGGER_WORKLOAD_API_PORT_EXTERNAL: "8020"

      # Docker socket via proxy
      DOCKER_HOST: "tcp://docker-proxy:2375"
      DOCKER_RUNNER_NETWORKS: "comp-net"
      DOCKER_AUTOREMOVE_EXITED_CONTAINERS: "true"
      DOCKER_ENFORCE_MACHINE_PRESETS: "true"

      # Registry (auth optional)
      DOCKER_REGISTRY_URL: "${DOCKER_REGISTRY_URL:-http://registry:5000}"
      DOCKER_REGISTRY_USERNAME: "${DOCKER_REGISTRY_USERNAME:-}"
      DOCKER_REGISTRY_PASSWORD: "${DOCKER_REGISTRY_PASSWORD:-}"

      DEBUG: "${SUPERVISOR_DEBUG:-0}"

    volumes:
      - shared-data:/home/node/shared
    networks:
      - comp-net
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://127.0.0.1:8020/health',(r)=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s

  docker-proxy:
    image: "tecnativa/docker-socket-proxy:latest"
    restart: unless-stopped
    environment:
      LOG_LEVEL: "info"
      POST: "1"
      CONTAINERS: "1"
      IMAGES: "1"
      INFO: "1"
      NETWORKS: "1"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - comp-net
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "2375"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 5s

  postgres:
    image: "postgres:16-alpine"
    restart: unless-stopped
    command: ["-c", "wal_level=logical"]
    environment:
      POSTGRES_USER: "${POSTGRES_USER:-postgres}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD}"
      POSTGRES_DB: "${POSTGRES_DB:-trigger}"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - comp-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 20s
      retries: 10

  redis:
    image: "redis:7"
    restart: unless-stopped
    volumes:
      - redis-data:/data
    networks:
      - comp-net
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  electric:
    image: "electricsql/electric:1.0.24"
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: "postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-trigger}?schema=public&sslmode=disable"
      ELECTRIC_INSECURE: "true"
      ELECTRIC_USAGE_REPORTING: "false"
    networks:
      - comp-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/v1/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  clickhouse:
    image: "bitnamilegacy/clickhouse:latest"
    restart: unless-stopped
    environment:
      CLICKHOUSE_ADMIN_USER: "${CLICKHOUSE_USER:-default}"
      CLICKHOUSE_ADMIN_PASSWORD: "${CLICKHOUSE_PASSWORD}"
    volumes:
      - clickhouse-data:/bitnami/clickhouse
    networks:
      - comp-net
    healthcheck:
      test: ["CMD", "clickhouse-client", "--host", "localhost", "--port", "9000", "--user", "${CLICKHOUSE_USER:-default}", "--password", "${CLICKHOUSE_PASSWORD}", "--query", "SELECT 1"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  registry:
    image: "registry:2"
    restart: unless-stopped
    volumes:
      - registry-data:/var/lib/registry
    networks:
      - comp-net
    ports:
      - "5000:5000"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:5000/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

volumes:
  postgres-data:
  redis-data:
  clickhouse-data:
  registry-data:
  shared-data:
  minio-data:
  pg-comp-data:

networks:
  comp-net:
    driver: bridge
